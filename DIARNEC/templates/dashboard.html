<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>DIARNEC DISTRIBUIDORA - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { background:#fff; }
    .sidebar { border-right:1px solid #e9ecef; }
    .kpi-card .icon{ font-size:2rem; opacity:.75; }
    .card{ border-radius:.8rem; }
    .card-header .btn-expand { border:0; }
    .modal-xxl { --bs-modal-width: min(1200px, 95vw); }
    .table-fixed-head thead th { position: sticky; top: 0; background: #fff; z-index: 1; }
    .alert-dot{width:.6rem;height:.6rem;border-radius:50%;display:inline-block;margin-right:.4rem}
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-light bg-light border-bottom">
    <div class="container-fluid">
      <a class="navbar-brand fw-semibold" href="{{ url_for('dashboard') }}">
        <i class="bi bi-shop me-2"></i>DIARNEC DISTRIBUIDORA
      </a>
      <div class="text-muted">
        <i class="bi bi-calendar3 me-1"></i><span id="hoy"></span>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Lateral -->
      <aside class="col-12 col-md-3 col-lg-2 py-3 sidebar">
        <div class="list-group">
          <a class="list-group-item list-group-item-action d-flex align-items-center" href="{{ url_for('ventas') }}">
            <i class="bi bi-cart me-2"></i> Ventas
          </a>
          <a class="list-group-item list-group-item-action d-flex align-items-center" href="{{ url_for('devoluciones') }}">
            <i class="bi bi-arrow-counterclockwise me-2"></i> Devoluciones
          </a>
          <a class="list-group-item list-group-item-action d-flex align-items-center" href="{{ url_for('pagos') }}">
            <i class="bi bi-cash-stack me-2"></i> Pagos
          </a>
          <a class="list-group-item list-group-item-action d-flex align-items-center" href="{{ url_for('inventario') }}">
            <i class="bi bi-archive me-2"></i> Inventario
          </a>
          <a class="list-group-item list-group-item-action d-flex align-items-center" href="{{ url_for('stock') }}">
            <i class="bi bi-box-arrow-in-down me-2"></i> Stock
          </a>
          <a class="list-group-item list-group-item-action d-flex align-items-center" href="{{ url_for('vendedores') }}">
            <i class="bi bi-people me-2"></i> Vendedores
          </a>
          <a class="list-group-item list-group-item-action d-flex align-items-center" href="{{ url_for('gastos') }}">
            <i class="bi bi-credit-card-2-back me-2"></i> Gastos
          </a>
          <a class="list-group-item list-group-item-action d-flex align-items-center" href="{{ url_for('proveedores') }}">
            <i class="bi bi-truck me-2"></i> Proveedores
          </a>
          <a class="list-group-item list-group-item-action d-flex align-items-center" href="{{ url_for('bonificaciones') }}">
            <i class="bi bi-gift me-2"></i> Bonificaciones
          </a>
        </div>

        <!-- Bajo stock -->
        <div class="mt-4">
          <div class="card">
            <div class="card-header py-2">Bajo stock ({{ stock_bajo }})</div>
            <div class="card-body py-2" style="max-height:200px;overflow:auto;">
              {% if productos_bajo_stock %}
                <ul class="mb-0 ps-3">
                  {% for p in productos_bajo_stock %}
                    <li class="small">{{ p['nombre'] }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="text-muted small">Sin alertas</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Vencimientos -->
        <div class="mt-3">
          <div class="card">
            <div class="card-header py-2">Vencimientos</div>
            <div class="card-body py-2 small">
              <div class="d-flex justify-content-between">
                <span><span class="alert-dot bg-warning"></span>Próximos 30d</span>
                <span class="fw-semibold">{{ vencimientos_proximos or 0 }}</span>
              </div>
              <div class="d-flex justify-content-between mt-1">
                <span><span class="alert-dot bg-danger"></span>Vencidos</span>
                <span class="fw-semibold">{{ vencimientos_vencidos or 0 }}</span>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Contenido -->
      <main class="col-12 col-md-9 col-lg-10 py-3">
        <!-- KPIs Hoy -->
        <div class="row g-3">
          <div class="col-6 col-md-3">
            <div class="card kpi-card text-center">
              <div class="card-body">
                <div class="icon text-success"><i class="bi bi-currency-dollar"></i></div>
                <div class="fw-semibold">Ventas Hoy</div>
                <div class="fs-4 mt-1">${{ '%.2f'|format(total_ventas or 0) }}</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card kpi-card text-center">
              <div class="card-body">
                <div class="icon text-primary"><i class="bi bi-box-seam"></i></div>
                <div class="fw-semibold">Productos</div>
                <div class="fs-4 mt-1">{{ total_productos }}</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card kpi-card text-center">
              <div class="card-body">
                <div class="icon text-warning"><i class="bi bi-exclamation-triangle"></i></div>
                <div class="fw-semibold">Bajo Stock</div>
                <div class="fs-4 mt-1">{{ stock_bajo }}</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card kpi-card text-center">
              <div class="card-body">
                <div class="icon text-info"><i class="bi bi-receipt"></i></div>
                <div class="fw-semibold">Ventas (cant.) Hoy</div>
                <div class="fs-4 mt-1">{{ cant_ventas_hoy }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- KPIs del MES -->
        <div class="row g-3 mt-1" id="kpisMesRow">
          <div class="col-6 col-lg-2">
            <div class="card text-center">
              <div class="card-body">
                <div class="icon text-success"><i class="bi bi-graph-up-arrow"></i></div>
                <div class="fw-semibold">Ventas mes</div>
                <div class="fs-5 mt-1" id="kpiVentasMes">–</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-lg-2">
            <div class="card text-center">
              <div class="card-body">
                <div class="icon text-danger"><i class="bi bi-credit-card-2-front"></i></div>
                <div class="fw-semibold">Gastos mes</div>
                <div class="fs-5 mt-1" id="kpiGastosMes">–</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-lg-2">
            <div class="card text-center">
              <div class="card-body">
                <div class="icon text-warning"><i class="bi bi-arrow-counterclockwise"></i></div>
                <div class="fw-semibold">Devoluciones</div>
                <div class="fs-5 mt-1" id="kpiDevMes">–</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-lg-2">
            <div class="card text-center">
              <div class="card-body">
                <div class="icon text-secondary"><i class="bi bi-gift"></i></div>
                <div class="fw-semibold">Bonificaciones</div>
                <div class="fs-5 mt-1" id="kpiBoniMes">–</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-lg-2">
            <div class="card text-center">
              <div class="card-body">
                <div class="icon text-info"><i class="bi bi-cash-coin"></i></div>
                <div class="fw-semibold">Pagos a vendedores</div>
                <div class="fs-6 mt-1" id="kpiPagosMes">–</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-2">
            <div class="card text-center">
              <div class="card-body">
                <div class="icon text-dark"><i class="bi bi-calculator"></i></div>
                <div class="fw-semibold">Rendimiento</div>
                <div class="fs-5 mt-1" id="kpiRendMes">–</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Alertas -->
        <div class="row g-3 mt-1">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Alertas</span>
                <button class="btn btn-light btn-sm btn-expand" data-expand="alertas"><i class="bi bi-arrows-fullscreen"></i></button>
              </div>
              <div class="card-body row">
                <div class="col-md-3">
                  <div class="fw-semibold mb-2"><span class="alert-dot bg-danger"></span>Stock bajo</div>
                  <ul class="small ps-3 mb-0" id="alStockBajo"></ul>
                </div>
                <div class="col-md-3">
                  <div class="fw-semibold mb-2"><span class="alert-dot bg-warning"></span>Stock cercano</div>
                  <ul class="small ps-3 mb-0" id="alStockCercano"></ul>
                </div>
                <div class="col-md-3">
                  <div class="fw-semibold mb-2"><span class="alert-dot bg-warning"></span>Vence en 30d</div>
                  <ul class="small ps-3 mb-0" id="alVence"></ul>
                </div>
                <div class="col-md-3">
                  <div class="fw-semibold mb-2"><span class="alert-dot bg-danger"></span>Vencidos</div>
                  <ul class="small ps-3 mb-0" id="alVencidos"></ul>
                  <div class="small mt-2 text-muted">Pérdida estimada: <span id="alPerdida">–</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Gráficos básicos (ventas + devueltos) -->
        <div class="row g-3 mt-1">
          <div class="col-lg-4">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Ventas por mes</span>
                <button class="btn btn-light btn-sm btn-expand" data-expand="mes" title="Ampliar"><i class="bi bi-arrows-fullscreen"></i></button>
              </div>
              <div class="card-body"><canvas id="chartMes"></canvas></div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Ventas por semana</span>
                <button class="btn btn-light btn-sm btn-expand" data-expand="semana" title="Ampliar"><i class="bi bi-arrows-fullscreen"></i></button>
              </div>
              <div class="card-body"><canvas id="chartSemana"></canvas></div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Ventas por día (30d)</span>
                <button class="btn btn-light btn-sm btn-expand" data-expand="dia" title="Ampliar"><i class="bi bi-arrows-fullscreen"></i></button>
              </div>
              <div class="card-body"><canvas id="chartDia"></canvas></div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Productos más devueltos (histórico)</span>
                <button class="btn btn-light btn-sm btn-expand" data-expand="devueltos" title="Ampliar"><i class="bi bi-arrows-fullscreen"></i></button>
              </div>
              <div class="card-body"><canvas id="chartDevueltos"></canvas></div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Mejores vendedores</span>
                <div class="d-flex align-items-center gap-2">
                  <ul class="nav nav-pills small">
                    <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pane-dia">Día</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-semana">Semana</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-mes">Mes</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-anio">Año</button></li>
                  </ul>
                  <button class="btn btn-light btn-sm btn-expand" data-expand="vendedores" title="Ampliar"><i class="bi bi-arrows-fullscreen"></i></button>
                </div>
              </div>
              <div class="card-body">
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="pane-dia"><ul id="bestDia" class="list-unstyled mb-0 small"></ul></div>
                  <div class="tab-pane fade" id="pane-semana"><ul id="bestSemana" class="list-unstyled mb-0 small"></ul></div>
                  <div class="tab-pane fade" id="pane-mes"><ul id="bestMes" class="list-unstyled mb-0 small"></ul></div>
                  <div class="tab-pane fade" id="pane-anio"><ul id="bestAnio" class="list-unstyled mb-0 small"></ul></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Rendimiento -->
        <div class="row g-3 mt-1">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Rendimiento del mes</span>
                <button class="btn btn-light btn-sm btn-expand" data-expand="rendimiento"><i class="bi bi-arrows-fullscreen"></i></button>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-3">
                    <div class="border rounded p-3 h-100">
                      <div class="text-muted small">Total</div>
                      <div class="fs-3 fw-semibold" id="rendTotal">–</div>
                      <div class="small text-muted">margen – gastos – bonif. – devoluciones – vencimientos</div>
                    </div>
                  </div>
                  <div class="col-md-9">
                    <div class="table-responsive">
                      <table class="table table-sm align-middle mb-0">
                        <tbody>
                          <tr><td>Ventas netas</td><td class="text-end" id="rendVentas">–</td></tr>
                          <tr><td>Costo de venta estimado</td><td class="text-end" id="rendCOGS">–</td></tr>
                          <tr class="table-light"><td>Margen bruto</td><td class="text-end" id="rendMargen">–</td></tr>
                          <tr><td>Gastos del mes</td><td class="text-end" id="rendGastos">–</td></tr>
                          <tr><td>Bonificaciones</td><td class="text-end" id="rendBonif">–</td></tr>
                          <tr><td>Devoluciones</td><td class="text-end" id="rendDevs">–</td></tr>
                          <tr><td>Pérdidas por vencimiento</td><td class="text-end" id="rendVenc">–</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Rankings de productos (vendidos / devueltos / pedidos) -->
        <div class="row g-3 mt-1">
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Productos más vendidos</span>
                <div class="d-flex align-items-center gap-2">
                  <ul class="nav nav-pills small" id="tabs-vendidos">
                    <li class="nav-item"><button class="nav-link active" data-range="semana">Semana</button></li>
                    <li class="nav-item"><button class="nav-link" data-range="mes">Mes</button></li>
                    <li class="nav-item"><button class="nav-link" data-range="anio">Año</button></li>
                  </ul>
                  <button class="btn btn-light btn-sm btn-expand" data-expand="vendidos"><i class="bi bi-arrows-fullscreen"></i></button>
                </div>
              </div>
              <div class="card-body"><canvas id="chartVendidos"></canvas></div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Productos más devueltos</span>
                <div class="d-flex align-items-center gap-2">
                  <ul class="nav nav-pills small" id="tabs-devueltos">
                    <li class="nav-item"><button class="nav-link active" data-range="semana">Semana</button></li>
                    <li class="nav-item"><button class="nav-link" data-range="mes">Mes</button></li>
                    <li class="nav-item"><button class="nav-link" data-range="anio">Año</button></li>
                  </ul>
                  <button class="btn btn-light btn-sm btn-expand" data-expand="devueltosPeriod"><i class="bi bi-arrows-fullscreen"></i></button>
                </div>
              </div>
              <div class="card-body"><canvas id="chartDevueltosPeriod"></canvas></div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Productos más pedidos</span>
                <div class="d-flex align-items-center gap-2">
                  <ul class="nav nav-pills small" id="tabs-pedidos">
                    <li class="nav-item"><button class="nav-link active" data-range="semana">Semana</button></li>
                    <li class="nav-item"><button class="nav-link" data-range="mes">Mes</button></li>
                    <li class="nav-item"><button class="nav-link" data-range="anio">Año</button></li>
                  </ul>
                  <button class="btn btn-light btn-sm btn-expand" data-expand="pedidos"><i class="bi bi-arrows-fullscreen"></i></button>
                </div>
              </div>
              <div class="card-body"><canvas id="chartPedidos"></canvas></div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Series: Ventas y Gastos</span>
                <div class="d-flex align-items-center gap-2">
                  <ul class="nav nav-pills small" id="tabs-series">
                    <li class="nav-item"><button class="nav-link active" data-range="semanal">Semanal</button></li>
                    <li class="nav-item"><button class="nav-link" data-range="mensual">Mensual</button></li>
                    <li class="nav-item"><button class="nav-link" data-range="anual">Anual</button></li>
                  </ul>
                  <button class="btn btn-light btn-sm btn-expand" data-expand="series"><i class="bi bi-arrows-fullscreen"></i></button>
                </div>
              </div>
              <div class="card-body"><canvas id="chartSeries"></canvas></div>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- Modal genérico de ampliación -->
  <div class="modal fade" id="modalExpand" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xxl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Detalle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3"><canvas id="modalChart" height="120"></canvas></div>
          <div class="table-responsive" style="max-height:45vh;overflow:auto;">
            <table class="table table-sm table-striped align-middle table-fixed-head">
              <thead id="modalThead"></thead>
              <tbody id="modalTbody"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Utilidades
    const fmtMoney = (n) => Number(n||0).toLocaleString('es-AR', {style:'currency', currency:'ARS', maximumFractionDigits:2});
    const fmtInt = (n) => Number(n||0).toLocaleString('es-AR');

    // Fecha
    (function(){
      const d = new Date();
      const s = d.toLocaleDateString('es-AR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
      document.getElementById('hoy').textContent = s.charAt(0).toUpperCase()+s.slice(1);
    })();

    // Estado
    let DATA = null;
    let charts = {}; // instancias Chart.js
    let modalChart = null;
    const modalEl = document.getElementById('modalExpand');

    // Render Chart helpers
    const renderBars = (canvasId, labels, values, label) => {
      if (charts[canvasId]) charts[canvasId].destroy();
      charts[canvasId] = new Chart(document.getElementById(canvasId), {
        type:'bar',
        data:{ labels, datasets:[{label, data:values}] },
        options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
      });
    };
    const renderLine = (canvasId, labels, values, label) => {
      if (charts[canvasId]) charts[canvasId].destroy();
      charts[canvasId] = new Chart(document.getElementById(canvasId), {
        type:'line',
        data:{ labels, datasets:[{label, data:values, tension:.3}] },
        options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
      });
    };

    // Modal chart + tabla
    function openModalChart({title, type, labels, values, valueLabel, headers, rows}) {
      document.getElementById('modalTitle').textContent = title;
      // Chart
      if (modalChart) modalChart.destroy();
      const ctx = document.getElementById('modalChart').getContext('2d');
      modalChart = new Chart(ctx, {
        type,
        data: { labels, datasets:[{ label: valueLabel, data: values, tension: .3 }] },
        options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });
      // Tabla
      const thead = document.getElementById('modalThead');
      const tbody = document.getElementById('modalTbody');
      thead.innerHTML = ''; tbody.innerHTML = '';
      const trh = document.createElement('tr');
      headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
      thead.appendChild(trh);
      rows.forEach(r => {
        const tr = document.createElement('tr');
        r.forEach((cell, i) => {
          const td = document.createElement('td');
          td.textContent = cell;
          if (i === r.length-1) td.classList.add('text-end');
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      new bootstrap.Modal(modalEl).show();
    }

    // Cargar datos
    fetch('{{ url_for("dashboard_data") }}')
      .then(r=>r.json())
      .then(data=>{
        DATA = data;

        // KPIs del mes
        const k = data.kpis_mes || {};
        document.getElementById('kpiVentasMes').textContent = fmtMoney(k.ventas_mes);
        document.getElementById('kpiGastosMes').textContent = fmtMoney(k.gastos_mes);
        document.getElementById('kpiDevMes').textContent    = fmtMoney(k.devoluciones_mes);
        document.getElementById('kpiBoniMes').textContent   = fmtMoney(k.bonificaciones_mes);
        document.getElementById('kpiPagosMes').textContent  = fmtMoney(k.pagos_mes);

        const r = data.rendimiento_mes || {};
        document.getElementById('kpiRendMes').textContent = fmtMoney(r.total);
        document.getElementById('rendTotal').textContent  = fmtMoney(r.total);
        document.getElementById('rendVentas').textContent = fmtMoney(r.ventas_netas);
        document.getElementById('rendCOGS').textContent   = fmtMoney(r.costo_venta_estimado);
        document.getElementById('rendMargen').textContent = fmtMoney(r.margen_bruto);
        document.getElementById('rendGastos').textContent = fmtMoney(r.gastos_mes);
        document.getElementById('rendBonif').textContent  = fmtMoney(r.bonificaciones_mes);
        document.getElementById('rendDevs').textContent   = fmtMoney(r.devoluciones_mes);
        document.getElementById('rendVenc').textContent   = fmtMoney(r.perdidas_vencimiento);

        // Alertas
        const A = data.alertas || {};
        const fillList = (id, arr, render) => {
          const el = document.getElementById(id); el.innerHTML='';
          if(!arr || !arr.length){ el.innerHTML='<li class="text-muted">Sin datos</li>'; return; }
          arr.slice(0,20).forEach(x => {
            const li = document.createElement('li'); li.className='small';
            li.textContent = render(x);
            el.appendChild(li);
          });
          if(arr.length>20){
            const li = document.createElement('li'); li.className='small text-muted';
            li.textContent = `+${arr.length-20} más...`; el.appendChild(li);
          }
        };
        fillList('alStockBajo', A.stock_bajo, x => `${x.nombre} (${x.marca||'–'}) — ${x.cantidad}/${x.cantidad_minima}`);
        fillList('alStockCercano', A.stock_cercano, x => `${x.nombre} (${x.marca||'–'}) — ${x.cantidad} (mín: ${x.cantidad_minima})`);
        fillList('alVence', A.vencimiento_proximo, x => `${x.nombre} (${x.marca||'–'}) — vence ${x.fecha_vencimiento} (${x.cantidad_restante})`);
        fillList('alVencidos', A.vencido, x => `${x.nombre} (${x.marca||'–'}) — vencido ${x.fecha_vencimiento} (${x.cantidad_restante})`);
        document.getElementById('alPerdida').textContent = fmtMoney(A.perdida_vencimiento||0);

        // Ventas por mes
        const mesLabels = data.ventas_mensuales.map(x=>x.mes);
        const mesValues = data.ventas_mensuales.map(x=>x.total);
        renderBars('chartMes', mesLabels, mesValues, 'Total');

        // Ventas por semana
        const semLabels = data.ventas_semanales.map(x=>x.semana);
        const semValues = data.ventas_semanales.map(x=>x.total);
        renderLine('chartSemana', semLabels, semValues, 'Total');

        // Ventas por día (30d)
        const diaLabels = data.ventas_diarias.map(x=>x.fecha);
        const diaValues = data.ventas_diarias.map(x=>x.total);
        renderLine('chartDia', diaLabels, diaValues, 'Total');

        // Devueltos (histórico)
        const devSrc = data.productos_mas_devueltos_hist || [];
        renderBars('chartDevueltos', devSrc.map(x=>x.producto), devSrc.map(x=>x.unidades), 'Unidades');

        // Mejores vendedores
        const renderTop=(arr,elId)=>{
          const el=document.getElementById(elId); el.innerHTML='';
          if(!arr||!arr.length){ el.innerHTML='<li class="text-muted">Sin datos</li>'; return; }
          arr.forEach((r,i)=>{
            const li=document.createElement('li');
            li.innerHTML=`<span class="me-2 fw-semibold">${i+1}.</span> ${r.vendedor} <span class="text-muted">— ${fmtMoney(r.total)}</span>`;
            el.appendChild(li);
          });
        };
        const mv = data.mejores_vendedores||{};
        renderTop(mv.dia,'bestDia');
        renderTop(mv.semana,'bestSemana');
        renderTop(mv.mes,'bestMes');
        renderTop(mv.anio,'bestAnio');

        // Rankings de productos por periodo
        const pmv = data.productos_mas_vendidos||{};
        const pmd = data.productos_mas_devueltos||{};
        const pmp = data.productos_mas_pedidos||{};
        const renderRankChart=(canvasId, src, range)=>{
          const list = src[range]||[];
          const labels = list.map(x=>x.producto);
          const values = list.map(x=>x.unidades);
          renderBars(canvasId, labels, values, 'Unidades');
        };
        // inicial
        renderRankChart('chartVendidos', pmv, 'semana');
        renderRankChart('chartDevueltosPeriod', pmd, 'semana');
        renderRankChart('chartPedidos', pmp, 'semana');

        // pestañas rankings
        function wireTabs(containerId, canvasId, src){
          document.querySelectorAll(`#${containerId} .nav-link`).forEach(btn=>{
            btn.addEventListener('click', ()=>{
              document.querySelectorAll(`#${containerId} .nav-link`).forEach(b=>b.classList.remove('active'));
              btn.classList.add('active');
              renderRankChart(canvasId, src, btn.getAttribute('data-range'));
            });
          });
        }
        wireTabs('tabs-vendidos','chartVendidos', pmv);
        wireTabs('tabs-devueltos','chartDevueltosPeriod', pmd);
        wireTabs('tabs-pedidos','chartPedidos', pmp);

        // Series (ventas/gastos)
        const series = data.series||{};
        const renderSeries=(range)=>{
          const sv = (series.ventas||{})[range]||[];
          const sg = (series.gastos||{})[range]||[];
          const labels = sv.map(x=>x.bucket);
          const vVals = sv.map(x=>x.total);
          const gMap = Object.fromEntries(sg.map(x=>[x.bucket, x.total]));
          const gVals = labels.map(l=>gMap[l]||0);

          // Doble dataset en una sola chart (ventas y gastos)
          if (charts['chartSeries']) charts['chartSeries'].destroy();
          charts['chartSeries'] = new Chart(document.getElementById('chartSeries'), {
            type:'line',
            data:{ labels, datasets:[
              { label:'Ventas', data:vVals, tension:.3 },
              { label:'Gastos', data:gVals, tension:.3 }
            ]},
            options:{responsive:true, scales:{y:{beginAtZero:true}}}
          });
        };
        renderSeries('semanal');
        document.querySelectorAll('#tabs-series .nav-link').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            document.querySelectorAll('#tabs-series .nav-link').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            renderSeries(btn.getAttribute('data-range'));
          });
        });

        // Botones Ampliar
        document.querySelectorAll('[data-expand]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const key = btn.getAttribute('data-expand');
            switch (key) {
              case 'mes': {
                const L = data.ventas_mensuales.map(x=>x.mes), V = data.ventas_mensuales.map(x=>x.total);
                openModalChart({
                  title: 'Ventas por mes (detalle)',
                  type: 'bar',
                  labels: L, values: V,
                  valueLabel: 'Total',
                  headers: ['Mes','Total'],
                  rows: L.map((m,i)=>[m, fmtMoney(V[i])])
                });
                break;
              }
              case 'semana': {
                const L = data.ventas_semanales.map(x=>x.semana), V = data.ventas_semanales.map(x=>x.total);
                openModalChart({
                  title: 'Ventas por semana (detalle)',
                  type: 'line',
                  labels: L, values: V,
                  valueLabel: 'Total',
                  headers: ['Semana','Total'],
                  rows: L.map((w,i)=>[w, fmtMoney(V[i])])
                });
                break;
              }
              case 'dia': {
                const L = data.ventas_diarias.map(x=>x.fecha), V = data.ventas_diarias.map(x=>x.total);
                openModalChart({
                  title: 'Ventas por día (últimos 30) — detalle',
                  type: 'line',
                  labels: L, values: V,
                  valueLabel: 'Total',
                  headers: ['Fecha','Total'],
                  rows: L.map((d,i)=>[d, fmtMoney(V[i])])
                });
                break;
              }
              case 'devueltos': {
                const src = data.productos_mas_devueltos_hist||[];
                openModalChart({
                  title: 'Productos más devueltos (histórico) — detalle',
                  type: 'bar',
                  labels: src.map(x=>x.producto),
                  values: src.map(x=>x.unidades),
                  valueLabel: 'Unidades',
                  headers: ['Producto','Unidades devueltas'],
                  rows: src.map(x=>[x.producto, fmtInt(x.unidades)])
                });
                break;
              }
              case 'vendedores': {
                const mes = (data.mejores_vendedores||{}).mes||[];
                openModalChart({
                  title: 'Mejores vendedores — Mes (detalle)',
                  type: 'bar',
                  labels: mes.map(x=>x.vendedor),
                  values: mes.map(x=>x.total),
                  valueLabel: 'Total vendido',
                  headers: ['#','Vendedor','Total'],
                  rows: mes.map((x,i)=>[String(i+1), x.vendedor, fmtMoney(x.total)])
                });
                break;
              }
              case 'vendidos': {
                const range = document.querySelector('#tabs-vendidos .nav-link.active').getAttribute('data-range');
                const src = (DATA.productos_mas_vendidos||{})[range]||[];
                openModalChart({
                  title: `Productos más vendidos — ${range}`,
                  type: 'bar',
                  labels: src.map(x=>x.producto),
                  values: src.map(x=>x.unidades),
                  valueLabel: 'Unidades',
                  headers: ['#','Producto','Unidades'],
                  rows: src.map((x,i)=>[String(i+1), x.producto, fmtInt(x.unidades)])
                });
                break;
              }
              case 'devueltosPeriod': {
                const range = document.querySelector('#tabs-devueltos .nav-link.active').getAttribute('data-range');
                const src = (DATA.productos_mas_devueltos||{})[range]||[];
                openModalChart({
                  title: `Productos más devueltos — ${range}`,
                  type: 'bar',
                  labels: src.map(x=>x.producto),
                  values: src.map(x=>x.unidades),
                  valueLabel: 'Unidades',
                  headers: ['#','Producto','Unidades'],
                  rows: src.map((x,i)=>[String(i+1), x.producto, fmtInt(x.unidades)])
                });
                break;
              }
              case 'pedidos': {
                const range = document.querySelector('#tabs-pedidos .nav-link.active').getAttribute('data-range');
                const src = (DATA.productos_mas_pedidos||{})[range]||[];
                openModalChart({
                  title: `Productos más pedidos — ${range}`,
                  type: 'bar',
                  labels: src.map(x=>x.producto),
                  values: src.map(x=>x.unidades),
                  valueLabel: 'Unidades',
                  headers: ['#','Producto','Unidades'],
                  rows: src.map((x,i)=>[String(i+1), x.producto, fmtInt(x.unidades)])
                });
                break;
              }
              case 'series': {
                const range = document.querySelector('#tabs-series .nav-link.active').getAttribute('data-range');
                const sv = (DATA.series?.ventas||{})[range]||[];
                const sg = (DATA.series?.gastos||{})[range]||[];
                const labels = sv.map(x=>x.bucket);
                const vVals = sv.map(x=>x.total);
                const gMap = Object.fromEntries(sg.map(x=>[x.bucket, x.total]));
                const gVals = labels.map(l=>gMap[l]||0);
                openModalChart({
                  title: `Series de Ventas y Gastos — ${range}`,
                  type: 'line',
                  labels,
                  values: vVals, // en modal muestro "Ventas" y tabla con ambos
                  valueLabel: 'Ventas',
                  headers: ['Bucket','Ventas','Gastos'],
                  rows: labels.map((b,i)=>[b, fmtMoney(vVals[i]), fmtMoney(gVals[i])])
                });
                break;
              }
              case 'alertas': {
                const A = DATA.alertas||{};
                const rows = [];
                (A.stock_bajo||[]).forEach(x=>rows.push(['Stock bajo', `${x.nombre} (${x.marca||'–'})`, `${x.cantidad}/${x.cantidad_minima}`, '']));
                (A.stock_cercano||[]).forEach(x=>rows.push(['Stock cercano', `${x.nombre} (${x.marca||'–'})`, `${x.cantidad} (mín ${x.cantidad_minima})`, '']));
                (A.vencimiento_proximo||[]).forEach(x=>rows.push(['Vence <30d', `${x.nombre} (${x.marca||'–'})`, x.fecha_vencimiento, `rest: ${x.cantidad_restante}`]));
                (A.vencido||[]).forEach(x=>rows.push(['Vencido', `${x.nombre} (${x.marca||'–'})`, x.fecha_vencimiento, `rest: ${x.cantidad_restante}`]));
                openModalChart({
                  title: 'Alertas — detalle',
                  type: 'bar',
                  labels: ['Stock bajo','Stock cercano','Vence <30d','Vencido'],
                  values: [
                    (A.stock_bajo||[]).length,
                    (A.stock_cercano||[]).length,
                    (A.vencimiento_proximo||[]).length,
                    (A.vencido||[]).length
                  ],
                  valueLabel: 'Cantidad',
                  headers: ['Tipo','Producto','Fecha/Detalle','Info'],
                  rows
                });
                break;
              }
              case 'rendimiento': {
                const r = DATA.rendimiento_mes||{};
                openModalChart({
                  title: 'Rendimiento del mes — desglose',
                  type: 'bar',
                  labels: ['Ventas','COGS','Margen','Gastos','Bonif.','Devoluciones','Vencimientos','Total'],
                  values: [r.ventas_netas, r.costo_venta_estimado, r.margen_bruto, r.gastos_mes, r.bonificaciones_mes, r.devoluciones_mes, r.perdidas_vencimiento, r.total],
                  valueLabel: 'Monto',
                  headers: ['Concepto','Monto'],
                  rows: [
                    ['Ventas netas', fmtMoney(r.ventas_netas)],
                    ['Costo estimado (COGS)', fmtMoney(r.costo_venta_estimado)],
                    ['Margen bruto', fmtMoney(r.margen_bruto)],
                    ['Gastos', fmtMoney(r.gastos_mes)],
                    ['Bonificaciones', fmtMoney(r.bonificaciones_mes)],
                    ['Devoluciones', fmtMoney(r.devoluciones_mes)],
                    ['Pérdidas por vencimiento', fmtMoney(r.perdidas_vencimiento)],
                    ['Total', fmtMoney(r.total)]
                  ]
                });
                break;
              }
            }
          });
        });
      });

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
